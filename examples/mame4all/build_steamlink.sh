#!/bin/bash
#

TOP=$(cd `dirname "${BASH_SOURCE[0]}"` && pwd)
if [ "${MARVELL_SDK_PATH}" = "" ]; then
	MARVELL_SDK_PATH="$(cd "${TOP}/../.." && pwd)"
fi
if [ "${MARVELL_ROOTFS}" = "" ]; then
	source "${MARVELL_SDK_PATH}/setenv.sh" || exit 1
fi
cd "${TOP}"

STEAMLINK=1 make $MAKE_J || exit 2

export DESTDIR="${PWD}/steamlink/apps/mame4all"

# Copy the files to the app directory
mkdir -p "${DESTDIR}"
cp -v mame "${DESTDIR}"
cp -v mame.cfg.template "${DESTDIR}/mame.cfg"
cp -v readme.txt cheat.dat clrmame.dat hiscore.dat "${DESTDIR}"
mkdir -p "${DESTDIR}/skins"
cp -v skins/*.bmp "${DESTDIR}/skins"
for dir in artwork cfg frontend hi inp memcard nvram roms samples snap folders; do
    mkdir -p "${DESTDIR}/${dir}"
    echo "Placeholder for ${dir} directory" >"${DESTDIR}/${dir}/dir.txt"
done
cp -a roms/* "${DESTDIR}/roms/"

# Strip the binary
armv7a-cros-linux-gnueabi-strip "${DESTDIR}/mame"

# Create the table of contents and icon
cat >"${DESTDIR}/toc.txt" <<__EOF__
name=Mame4All
icon=icon.png
run=mame
__EOF__

base64 -d >"${DESTDIR}/icon.png" <<__EOF__
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
Z5Ia+tpuAAAAAElFTkSuQmCC
__EOF__

# Pack it up
name=$(basename ${DESTDIR})
pushd "$(dirname ${DESTDIR})"
tar zcvf $name.tgz $name || exit 3
rm -rf $name
popd

# All done!
echo "Build complete!"
echo
echo "Put the steamlink folder onto a USB drive, insert it into your Steam Link, and cycle the power to install."
